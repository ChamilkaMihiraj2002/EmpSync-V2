name: Docker Build

on: [pull_request, workflow_dispatch]

jobs:
    docker-production-build:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:latest
                ports:
                    - 5432:5432
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: mysecretpassword
                    POSTGRES_DB: mydatabase

        steps: 
            - name: Checkout Code
              uses: actions/checkout@v2

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v1

            - name: Cache Docker Layers
              uses: actions/cache@v2
              with:
                path: /tmp/.buildx-cache
                key: ${{ runner.os }}-buildx-${{ github.sha }}
                restore-keys: |
                    ${{ runner.os }}-buildx-

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v1
    
            - name: Login to DockerHub
              uses: docker/login-action@v1
              with:
                username: ${{ secrets.anjed11 }}
                password: ${{ secrets.Teammaverick }}
    
            - name: Build and push
              uses: docker/build-push-action@v2
              with:
                context: .
                file: ./server/docker-compose.yml
                push: false
                tags: user/repository:latest
    
            - name: Run Docker Compose
              run: docker-compose -f ./server/docker-compose.yml up --build -d
    
            - name: Run tests
              run: docker-compose -f ./server/docker-compose.yml exec nestjs npm test
        


                



